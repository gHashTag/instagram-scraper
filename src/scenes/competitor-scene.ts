import { Scenes, Markup } from "telegraf";
import { ScraperBotContext } from "../types";
import { NeonAdapter } from "../adapters/neon-adapter";
import { ScraperSceneStep, ScraperSceneSessionData } from "@/types";
import { User } from "../types";

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞.
 */
export const handleDeleteCompetitorAction = async (
  ctx: ScraperBotContext & { match: RegExpExecArray }
) => {
  const adapter = ctx.storage as NeonAdapter;
  const projectId = parseInt(ctx.match[1], 10);
  const username = ctx.match[2];

  if (isNaN(projectId) || !username) {
    console.error(
      `Invalid data parsed from delete action: projectId=${ctx.match[1]}, username=${ctx.match[2]}`
    );
    await ctx.reply(
      "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    );
    await ctx.answerCbQuery("–û—à–∏–±–∫–∞");
    return;
  }

  let success = false;
  try {
    await adapter.initialize();
    success = await adapter.deleteCompetitorAccount(projectId, username);

    if (success) {
      await ctx.reply(`–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç "${username}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞.`);
      await ctx.editMessageReplyMarkup(undefined);
      await ctx.answerCbQuery("–£–¥–∞–ª–µ–Ω–æ");
    } else {
      await ctx.reply(
        `–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ "${username}". –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —É–∂–µ –±—ã–ª —É–¥–∞–ª–µ–Ω.`
      );
      await ctx.answerCbQuery("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  } catch (error) {
    console.error(
      `–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ ${username} –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ ${projectId}:`,
      error
    );
    await ctx.reply(
      "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    );
    await ctx.answerCbQuery("–û—à–∏–±–∫–∞");
  } finally {
    if (adapter) {
      await adapter.close();
    }
  }
};

/**
 * –°—Ü–µ–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
 */
export const competitorScene = new Scenes.BaseScene<
  ScraperBotContext & { scene: { session: ScraperSceneSessionData } }
>("instagram_scraper_competitors");

// –í—Ö–æ–¥ –≤ —Å—Ü–µ–Ω—É - –≤—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –ø–æ–∫–∞–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –æ–¥–∏–Ω
competitorScene.enter(async (ctx) => {
  const adapter = ctx.storage as NeonAdapter;
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º adapter –≤–º–µ—Å—Ç–æ neonAdapter
    await adapter.initialize();

    const user = await adapter.getUserByTelegramId(ctx.from?.id || 0);

    if (!user) {
      await ctx.reply(
        "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã."
      );
      await adapter.close();
      return ctx.scene.leave(); // –Ø–≤–Ω—ã–π return
    }

    const projects = await adapter.getProjectsByUserId(user.id as number); // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–∞ user.id

    if (!projects || projects.length === 0) {
      await ctx.reply(
        "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /projects"
      );
      await adapter.close();
      return ctx.scene.leave(); // –Ø–≤–Ω—ã–π return
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    if (projects.length === 1) {
      const competitors = await adapter.getCompetitorAccounts(projects[0].id);

      if (!competitors || competitors.length === 0) {
        await ctx.reply(
          `–í –ø—Ä–æ–µ–∫—Ç–µ "${projects[0].name}" –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å?`,
          {
            reply_markup: Markup.inlineKeyboard([
              [
                Markup.button.callback(
                  "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
                  `add_competitor_${projects[0].id}`
                ),
              ],
              [Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")],
            ]).reply_markup,
          }
        );
      } else {
        const competitorList = competitors
          .map((c, i) => `${i + 1}. [${c.username}](${c.instagram_url})`)
          .join("\n");

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è
        const competitorButtons = competitors.map((c) => [
          Markup.button.callback(
            `üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${c.username}`,
            `delete_competitor_${projects[0].id}_${c.username}`
          ),
        ]);

        await ctx.reply(
          `–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ "${projects[0].name}":\n\n${competitorList}\n\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?`,
          {
            parse_mode: "Markdown",
            reply_markup: Markup.inlineKeyboard([
              ...competitorButtons, // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
              [
                Markup.button.callback(
                  "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
                  `add_competitor_${projects[0].id}`
                ),
              ],
              [Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")],
            ]).reply_markup,
          }
        );
      }
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤, –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å
      const projectButtons = projects.map((project) => [
        Markup.button.callback(
          project.name,
          `competitors_project_${project.id}`
        ),
      ]);

      projectButtons.push([Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")]);

      await ctx.reply("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤:", {
        reply_markup: Markup.inlineKeyboard(projectButtons).reply_markup,
      });
    }

    await adapter.close();
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤:", error);
    await ctx.reply(
      "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    );
    // await adapter.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤ finally –∏–ª–∏ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º
    await ctx.scene.leave();
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
competitorScene.action(/competitors_project_(\d+)/, async (ctx) => {
  const adapter = ctx.storage as NeonAdapter;
  const projectId = parseInt(ctx.match[1]);

  try {
    await adapter.initialize();

    const competitors = await adapter.getCompetitorAccounts(projectId);

    if (!competitors || competitors.length === 0) {
      await ctx.reply(
        "–í –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å?",
        {
          reply_markup: Markup.inlineKeyboard([
            [
              Markup.button.callback(
                "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
                `add_competitor_${projectId}`
              ),
            ],
            [Markup.button.callback("–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º", "back_to_projects")],
            [Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")],
          ]).reply_markup,
        }
      );
    } else {
      const competitorList = competitors
        .map((c, i) => `${i + 1}. [${c.username}](${c.instagram_url})`)
        .join("\n");

      // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è
      const competitorButtons = competitors.map((c) => [
        Markup.button.callback(
          `üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${c.username}`,
          `delete_competitor_${projectId}_${c.username}`
        ),
      ]);

      await ctx.reply(
        `–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ:\n\n${competitorList}\n\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?`,
        {
          parse_mode: "Markdown",
          reply_markup: Markup.inlineKeyboard([
            ...competitorButtons, // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            [
              Markup.button.callback(
                "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
                `add_competitor_${projectId}`
              ),
            ],
            [Markup.button.callback("–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º", "back_to_projects")],
            [Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")],
          ]).reply_markup,
        }
      );
    }

    await adapter.close();
  } catch (error) {
    console.error(
      `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ ${projectId}:`,
      error
    );
    await ctx.reply(
      "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    );
    // await adapter.close();
  }

  await ctx.answerCbQuery();
});

// –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
competitorScene.action(/add_competitor_(\d+)/, async (ctx) => {
  // –ó–¥–µ—Å—å –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏—è
  const projectId = parseInt(ctx.match[1]);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
  if (isNaN(projectId)) {
    console.error(`Invalid projectId parsed from action: ${ctx.match[1]}`);
    await ctx.reply(
      "–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞–∑–∞–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç —Å–Ω–æ–≤–∞."
    );
    await ctx.answerCbQuery();
    return; // –í—ã—Ö–æ–¥
  }

  ctx.scene.session.projectId = projectId;

  await ctx.reply(
    "–í–≤–µ–¥–∏—Ç–µ Instagram URL –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://www.instagram.com/example):"
  );
  ctx.scene.session.step = ScraperSceneStep.ADD_COMPETITOR;

  await ctx.answerCbQuery();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
competitorScene.on("text", async (ctx) => {
  const adapter = ctx.storage as NeonAdapter;
  if (ctx.scene.session.step === ScraperSceneStep.ADD_COMPETITOR) {
    const instagramUrl = ctx.message.text.trim();
    const projectId = ctx.scene.session.projectId;

    let user: User | null = null;

    if (!projectId) {
      await ctx.reply("–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –ø—Ä–æ–µ–∫—Ç. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.");
      return ctx.scene.reenter();
    }

    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ URL, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
    if (!instagramUrl.toLowerCase().includes("instagram.com/")) {
      await ctx.reply(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://www.instagram.com/example):"
      );
      return; // –Ø–≤–Ω—ã–π –≤—ã—Ö–æ–¥, –µ—Å–ª–∏ URL –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
    }

    try {
      await adapter.initialize();

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–ï–†–ï–î –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
      user = await adapter.getUserByTelegramId(ctx.from?.id || 0);
      if (!user) {
        console.error(
          `Error in onText handler: User not found for telegramId: ${ctx.from?.id}`
        );
        await ctx.reply(
          "–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start."
        );
        ctx.scene.session.step = undefined;
        await adapter.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –∑–¥–µ—Å—å
        return ctx.scene.leave(); // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å—Ü–µ–Ω—ã
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL
      let username = instagramUrl.substring(instagramUrl.lastIndexOf("/") + 1);
      // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL —Ç–∏–ø–∞ ?igshid=...
      username = username.split("?")[0];
      // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ
      if (username.endsWith("/")) {
        username = username.slice(0, -1);
      }

      if (!username) {
        await ctx.reply(
          "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
        );
        return; // –Ø–≤–Ω—ã–π –≤—ã—Ö–æ–¥
      }

      const competitor = await adapter.addCompetitorAccount(
        projectId,
        username,
        instagramUrl
      );

      if (competitor) {
        const successMessage = `–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç @${username} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`;
        const successKeyboard = Markup.inlineKeyboard([
          [
            Markup.button.callback(
              "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤",
              `competitors_project_${projectId}`
            ),
          ],
          [
            Markup.button.callback(
              "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞",
              `add_competitor_${projectId}`
            ),
          ],
          [Markup.button.callback("–í—ã–π—Ç–∏", "exit_scene")],
        ]);
        await ctx.reply(successMessage, {
          reply_markup: successKeyboard.reply_markup,
        });
        if (adapter && typeof adapter.close === "function") {
          await adapter.close();
        }
      } else {
        const errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ @${username}. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.`;
        await ctx.reply(errorMessage);
        if (adapter && typeof adapter.close === "function") {
          await adapter.close();
        }
      }

      ctx.scene.session.step = undefined; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥
      return; // –Ø–≤–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –≤ —Å—Ü–µ–Ω–µ:", error);
      await ctx.reply(
        "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
      );
      ctx.scene.session.step = undefined; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      if (adapter && typeof adapter.close === "function") {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –≤ catch
        await adapter.close();
      }
      return; // –Ø–≤–Ω—ã–π –≤—ã—Ö–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    }
  } else {
    // –ï—Å–ª–∏ —à–∞–≥ –Ω–µ ADD_COMPETITOR, —Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–∞—á–∞–ª–æ
    // –î–ª—è —è–≤–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å return –∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    return; // –Ø–≤–Ω—ã–π –≤—ã—Ö–æ–¥, –µ—Å–ª–∏ —à–∞–≥ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í—ã–π—Ç–∏"
competitorScene.action("exit_scene", async (ctx) => {
  await ctx.reply("–í—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏.", {
    reply_markup: { remove_keyboard: true },
  });
  await ctx.scene.leave();
  await ctx.answerCbQuery();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º" (–≤–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—É —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞)
competitorScene.action("back_to_projects", async (ctx) => {
  await ctx.scene.reenter();
  await ctx.answerCbQuery();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
competitorScene.action(
  /delete_competitor_(\d+)_(.+)/,
  handleDeleteCompetitorAction
);

export default competitorScene;
